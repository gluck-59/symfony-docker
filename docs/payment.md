# Подсистема платежей (Payment)

Подсистема `Payment` фиксирует приходы и расходы по заявке (`Request`). Все суммы хранятся в **копейках**, поэтому при отображении необходимо делить значение на 100. Основные компоненты подсистемы: сущность `App\Entity\Payment`, контроллер `App\Controller\PaymentController`, репозиторий `App\Repository\PaymentRepository` и шаблон `templates/request/edit.html.twig`.

## Структура данных

- **Сущность:** `Payment`
- **Ключевые поля:**
  - `request` — ссылка на родительскую заявку.
  - `type` — статья платежа (`TYPE_OVERHEAD` — накладные, `TYPE_WORK` — работа).
  - `sum` — целочисленное значение в копейках (знак определяет приход/расход).
  - `note` — комментарий.
  - `created` — дата и время создания записи.

## Репозиторий `PaymentRepository`

- `findByRequest(Request $request)` — возвращает список платежей заявки.
- `getTotalsByRequest(Request $request)` — агрегирует приход и расход (в копейках).
- `getSumByRequestIds(array $requestIds)` — суммирует платежи для множества заявок; используется в `RequestController::index()` для отображения балансов в списке.

## Контроллер `PaymentController`

| Маршрут | Описание |
| --- | --- |
| `POST /payment` (`payment_create`) | Создаёт платеж. Принимает `_token`, `requestId`, `type`, `direction`, `sum`, `note`. Сумма переводится в копейки, знак зависит от `direction` (1 — приход, 0 — расход). Возвращает JSON с данными платежа и агрегированными totals. |
| `PATCH /payment/{id}/sum` (`payment_update_sum`) | Обновляет сумму существующего платежа (используется при inline-редактировании). Требует `_token` и новую сумму. Возвращает обновлённые totals и данные для бейджа. |
| `DELETE /payment/{id}` (`payment_delete`) | Удаляет платеж. Возвращает totals после пересчёта. |

Контроллер проверяет авторизацию: доступ есть у администратора или у автора клиента, которому принадлежит заявка (`denyPaymentAccess()`). Для каждой операции используется индивидуальный CSRF-токен.

## Пользовательский интерфейс

- Шаблон `templates/request/edit.html.twig` подключает модальное окно `templates/payment/modal.html.twig`, в котором сумма вводится вручную или через экранную клавиатуру.
- После открытия модалки кнопка `.btn.calculate` (есть версии для desktop и mobile) отправляет данные на `payment_create`.
- Таблица истории платежей позволяет:
  - редактировать сумму (`payment_update_sum`),
  - удалять запись (`payment_delete`).
- Функция `updatePaymentTotals()` обновляет приход, расход и баланс (`#requestBalance`) и присваивает бейджу цвет по знаку.

## Форматирование сумм

- Сервер: `PaymentController::formatAmountRub()` использует `NumberFormatter('ru_RU')` без дробной части.
- Клиент: применяет `Intl.NumberFormat('ru-RU')` для динамического отображения.
- Twig-фильтр `money_rub` ожидает значение в рублях, поэтому перед вызовом большинство шаблонов делят сумму на 100.
